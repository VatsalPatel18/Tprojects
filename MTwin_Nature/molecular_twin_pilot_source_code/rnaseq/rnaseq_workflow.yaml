"apiVersion": "argoproj.io/v1alpha1"
"kind": "Workflow"
"metadata":
  "generateName": "rnaseq-workflow-"
  "annotations":
    "cluster-autoscaler.kubernetes.io/safe-to-evict": "false"
    "betteromics-snapshot-output": "s3://betteromics-data-platform/data_manager/cedars_sinai/molecular_twin_pilot/RNA/kallisto/"
"spec":
  "ttlStrategy":
    "secondsAfterCompletion": !!int "7200"
    "secondsAfterSuccess": !!int "7200"
    "secondsAfterFailure": !!int "7200"
  "entrypoint": "rnaseq-workflow"
  "podGC":
    "strategy": "OnPodSuccess"
  "parallelism": !!int "1000"
  "imagePullSecrets":
  - "name": "docker-registry-secret"
  "templates":
  - "name": "quantify-paired-end"
    "metadata":
      "annotations":
        "cluster-autoscaler.kubernetes.io/safe-to-evict": "false"
    "retryStrategy":
      "limit": !!int "10"
      "retryPolicy": "OnError"
    "inputs":
      "parameters":
      - "name": "script"
      "artifacts":
      - "name": "inputs"
        "path": "/tmp/inputs"
        "s3":
          "endpoint": "s3.amazonaws.com"
          "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/kallisto/quantify-paired-end/gathered_outputs"
          "region": "us-west-2"
          "accessKeySecret":
            "name": "my-s3-credentials"
            "key": "accessKey"
          "secretKeySecret":
            "name": "my-s3-credentials"
            "key": "secretKey"
    "script":
      "image": "965350412536.dkr.ecr.us-west-2.amazonaws.com/betteromics-python-slim:latest"
      "command":
      - "python"
      "source": "{{inputs.parameters.script}}"
      "resources":
        "requests":
          "cpu": !!float "0.8"
          "memory": "7.0Gi"
          "ephemeral-storage": "7.0Gi"
    "outputs":
      "artifacts":
      - "name": "output"
        "path": "/tmp/output"
        "archive":
          "none": {}
      - "name": "metrics"
        "path": "/tmp/metrics"
        "archive":
          "none": {}
  - "name": "sharded-file-input-quantify-paired-end-quantify-paired-end"
    "metadata":
      "annotations":
        "cluster-autoscaler.kubernetes.io/safe-to-evict": "false"
    "retryStrategy":
      "limit": !!int "10"
      "retryPolicy": "OnError"
    "inputs":
      "parameters":
      - "name": "sample"
      "artifacts":
      - "name": "input1"
        "path": "/tmp/input1"
      - "name": "transcriptome_index"
        "path": "/tmp/transcriptome_index"
        "s3":
          "endpoint": "s3.amazonaws.com"
          "bucket": "betteromics-data-platform"
          "key": "references/kallisto/homo_sapiens/transcriptome.idx"
          "region": "us-west-2"
          "accessKeySecret":
            "name": "my-s3-credentials"
            "key": "accessKey"
          "secretKeySecret":
            "name": "my-s3-credentials"
            "key": "secretKey"
      - "name": "tsv_to_csv"
        "path": "/tmp/tsv_to_csv"
        "s3":
          "endpoint": "s3.amazonaws.com"
          "bucket": "betteromics-data-platform"
          "key": "references/tsv_to_csv.py"
          "region": "us-west-2"
          "accessKeySecret":
            "name": "my-s3-credentials"
            "key": "accessKey"
          "secretKeySecret":
            "name": "my-s3-credentials"
            "key": "secretKey"
    "script":
      "image": "965350412536.dkr.ecr.us-west-2.amazonaws.com/kallisto:cedars_rna_seq_v2"
      "command":
      - "sh"
      "source": "export INPUT=/tmp/input1\nexport OUTPUT=/tmp/output.csv\nexport ARTIFACTS=/tmp/artifacts\nmkdir $ARTIFACTS\n            \n#!/bin/bash\n\nset -exu\n\n# $INPUT is already unzipped from tar.gz to *fastq.gz files\n\nFILE1=$(ls $INPUT/*_1.fastq.gz)\nFILE2=$(ls $INPUT/*_[23].fastq.gz)\ntime kallisto quant \\\n        -i /tmp/transcriptome_index \\\n        -t 4 \\\n        -b 100 \\\n        -o $ARTIFACTS \\\n        $FILE1 $FILE2\n\nls -l $ARTIFACTS\n\necho \"TEST\\nTEST2\" > $OUTPUT\n\n# convert tsv to csv, pivot\npython /tmp/tsv_to_csv $ARTIFACTS/abundance.tsv $OUTPUT\n\n# csvtk abundances.tsv abundances.csv\n"
      "resources":
        "requests":
          "cpu": !!float "0.8"
          "memory": "7.0Gi"
          "ephemeral-storage": "7.0Gi"
    "outputs":
      "artifacts":
      - "name": "output"
        "path": "/tmp/output.csv"
        "archive":
          "none": {}
        "s3":
          "endpoint": "s3.amazonaws.com"
          "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/kallisto/quantify-paired-end/gathered_outputs/{{inputs.parameters.sample}}"
          "region": "us-west-2"
          "accessKeySecret":
            "name": "my-s3-credentials"
            "key": "accessKey"
          "secretKeySecret":
            "name": "my-s3-credentials"
            "key": "secretKey"
      - "name": "artifacts"
        "path": "/tmp/artifacts"
        "optional": !!bool "true"
        "archive":
          "none": {}
        "s3":
          "endpoint": "s3.amazonaws.com"
          "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/kallisto/quantify-paired-end/{{inputs.parameters.sample}}-artifacts"
          "region": "us-west-2"
          "accessKeySecret":
            "name": "my-s3-credentials"
            "key": "accessKey"
          "secretKeySecret":
            "name": "my-s3-credentials"
            "key": "secretKey"
  - "name": "materialized-node"
    "metadata":
      "annotations":
        "cluster-autoscaler.kubernetes.io/safe-to-evict": "false"
    "retryStrategy":
      "limit": !!int "10"
      "retryPolicy": "OnError"
    "inputs":
      "parameters":
      - "name": "script"
      "artifacts":
      - "name": "dataframe1"
        "path": "/tmp/dataframe1"
    "script":
      "image": "965350412536.dkr.ecr.us-west-2.amazonaws.com/betteromics-python-expanded:latest"
      "command":
      - "python"
      "source": "{{inputs.parameters.script}}"
      "resources":
        "requests":
          "cpu": !!float "0.8"
          "memory": "7.0Gi"
          "ephemeral-storage": "7.0Gi"
    "outputs":
      "artifacts":
      - "name": "stats"
        "path": "/tmp/stats.json"
        "archive":
          "none": {}
      - "name": "schema"
        "path": "/tmp/schema.json"
        "archive":
          "none": {}
  - "name": "rnaseq-workflow"
    "dag":
      "tasks":
      - "name": "quantify-paired-end-sharded"
        "template": "sharded-file-input-quantify-paired-end-quantify-paired-end"
        "arguments":
          "parameters":
          - "name": "sample"
            "value": "{{item.sample}}"
          "artifacts":
          - "name": "input1"
            "path": "/tmp/input1"
            "s3":
              "endpoint": "s3.amazonaws.com"
              "bucket": "{{item.bucket}}"
              "key": "{{item.key}}"
              "region": "us-west-2"
              "accessKeySecret":
                "name": "my-s3-credentials"
                "key": "accessKey"
              "secretKeySecret":
                "name": "my-s3-credentials"
                "key": "secretKey"
        "withItems":
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-13-844_MTPC1.tar.gz"
          "sample": "GI-13-844_MTPC1"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-13-930_MTPC3.tar.gz"
          "sample": "GI-13-930_MTPC3"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-297_MTPC11.tar.gz"
          "sample": "GI-14-297_MTPC11"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-389_MTPC15.tar.gz"
          "sample": "GI-14-389_MTPC15"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-429_MTPC17.tar.gz"
          "sample": "GI-14-429_MTPC17"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-466_MTPC23.tar.gz"
          "sample": "GI-14-466_MTPC23"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-575_MTPC27.tar.gz"
          "sample": "GI-14-575_MTPC27"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-594_MTPC29.tar.gz"
          "sample": "GI-14-594_MTPC29"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-600_MTPC31.tar.gz"
          "sample": "GI-14-600_MTPC31"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-760_MTPC35.tar.gz"
          "sample": "GI-14-760_MTPC35"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-881_MTPC39.tar.gz"
          "sample": "GI-14-881_MTPC39"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-14-974_MTPC33.tar.gz"
          "sample": "GI-14-974_MTPC33"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-024_MTPC41.tar.gz"
          "sample": "GI-16-024_MTPC41"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-035_MTPC43.tar.gz"
          "sample": "GI-16-035_MTPC43"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-041_MTPC45.tar.gz"
          "sample": "GI-16-041_MTPC45"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-102_MTPC49.tar.gz"
          "sample": "GI-16-102_MTPC49"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-109_MTPC51.tar.gz"
          "sample": "GI-16-109_MTPC51"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-234_MTPC53.tar.gz"
          "sample": "GI-16-234_MTPC53"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-336_MTPC57.tar.gz"
          "sample": "GI-16-336_MTPC57"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-370_MTPC59.tar.gz"
          "sample": "GI-16-370_MTPC59"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-433_MTPC65.tar.gz"
          "sample": "GI-16-433_MTPC65"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-444_MTPC67.tar.gz"
          "sample": "GI-16-444_MTPC67"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-551_MTPC72.tar.gz"
          "sample": "GI-16-551_MTPC72"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-575_MTPC73.tar.gz"
          "sample": "GI-16-575_MTPC73"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-590_MTPC75.tar.gz"
          "sample": "GI-16-590_MTPC75"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-650_MTPC77.tar.gz"
          "sample": "GI-16-650_MTPC77"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-664_MTPC79.tar.gz"
          "sample": "GI-16-664_MTPC79"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-672_MTPC81.tar.gz"
          "sample": "GI-16-672_MTPC81"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-16-739_MTPC83.tar.gz"
          "sample": "GI-16-739_MTPC83"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-123_MTPC89.tar.gz"
          "sample": "GI-17-123_MTPC89"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-182_MTPC91.tar.gz"
          "sample": "GI-17-182_MTPC91"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-267_MTPC93.tar.gz"
          "sample": "GI-17-267_MTPC93"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-306_MTPC95.tar.gz"
          "sample": "GI-17-306_MTPC95"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-390_MTPC97.tar.gz"
          "sample": "GI-17-390_MTPC97"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-404_MTPC99.tar.gz"
          "sample": "GI-17-404_MTPC99"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-480_MTPC105.tar.gz"
          "sample": "GI-17-480_MTPC105"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-500_MTPC107.tar.gz"
          "sample": "GI-17-500_MTPC107"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-513_MTPC109.tar.gz"
          "sample": "GI-17-513_MTPC109"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-537_MTPC111.tar.gz"
          "sample": "GI-17-537_MTPC111"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-563_MTPC113.tar.gz"
          "sample": "GI-17-563_MTPC113"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-615_MTPC117.tar.gz"
          "sample": "GI-17-615_MTPC117"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-699_MTPC119.tar.gz"
          "sample": "GI-17-699_MTPC119"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-813_MTPC122.tar.gz"
          "sample": "GI-17-813_MTPC122"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-816_MTPC123.tar.gz"
          "sample": "GI-17-816_MTPC123"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-17-933_MTPC127.tar.gz"
          "sample": "GI-17-933_MTPC127"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-011_MTPC129.tar.gz"
          "sample": "GI-18-011_MTPC129"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-114_MTPC133.tar.gz"
          "sample": "GI-18-114_MTPC133"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-234_MTPC135.tar.gz"
          "sample": "GI-18-234_MTPC135"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-302_MTCP137.tar.gz"
          "sample": "GI-18-302_MTCP137"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-352_MTPC139.tar.gz"
          "sample": "GI-18-352_MTPC139"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-356_MTPC141.tar.gz"
          "sample": "GI-18-356_MTPC141"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-423_MTPC143.tar.gz"
          "sample": "GI-18-423_MTPC143"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-444_MTPC147.tar.gz"
          "sample": "GI-18-444_MTPC147"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-611_MTPC149.tar.gz"
          "sample": "GI-18-611_MTPC149"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-636_MTPC151.tar.gz"
          "sample": "GI-18-636_MTPC151"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-661_MTPC153.tar.gz"
          "sample": "GI-18-661_MTPC153"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-665_MTPC155.tar.gz"
          "sample": "GI-18-665_MTPC155"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-674_MTPC157.tar.gz"
          "sample": "GI-18-674_MTPC157"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-690_MTPC159.tar.gz"
          "sample": "GI-18-690_MTPC159"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-18-779_MTPC161.tar.gz"
          "sample": "GI-18-779_MTPC161"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-001_MTPC163.tar.gz"
          "sample": "GI-19-001_MTPC163"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-002_MTPC165.tar.gz"
          "sample": "GI-19-002_MTPC165"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-025_MTPC167.tar.gz"
          "sample": "GI-19-025_MTPC167"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-061_MTPC169.tar.gz"
          "sample": "GI-19-061_MTPC169"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-081_MTPC173.tar.gz"
          "sample": "GI-19-081_MTPC173"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-082_MTPC175.tar.gz"
          "sample": "GI-19-082_MTPC175"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-120_MTPC179.tar.gz"
          "sample": "GI-19-120_MTPC179"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-150_MTPC181.tar.gz"
          "sample": "GI-19-150_MTPC181"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-176_MTPC185.tar.gz"
          "sample": "GI-19-176_MTPC185"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-206_MTPC187.tar.gz"
          "sample": "GI-19-206_MTPC187"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-217_MTPC189.tar.gz"
          "sample": "GI-19-217_MTPC189"
        - "bucket": "betteromics-data-platform"
          "key": "data_manager/cedars_sinai/molecular_twin_pilot/RNA/GI-19-234_MTPC191.tar.gz"
          "sample": "GI-19-234_MTPC191"
      - "name": "quantify-paired-end"
        "template": "quantify-paired-end"
        "dependencies":
        - "quantify-paired-end-sharded"
        "arguments":
          "parameters":
          - "name": "script"
            "value": "import pandas as pd\nfrom pandas.errors import EmptyDataError\nimport os\nimport json\ndirectory = \"/tmp/inputs\"\nfiles = os.listdir(directory)\n\ndef get_header_lines(files, directory):\n    header_lines = set()\n    for file in files:\n        with open(os.path.join(directory, file), \"r\") as f:\n            header_lines.update(f.readline().strip().split(\",\"))\n    header_lines = list(header_lines)\n    header_lines = [h for h in header_lines if h]\n    return header_lines\n\ndef write_merged_file(files, header, directory):\n    dfs = []\n    for file in files:\n        try:\n            df = pd.read_csv(os.path.join(directory, file))\n        except EmptyDataError:\n            df = pd.DataFrame()\n            print(f\"{file} did not contain any rows\")\n        df = df.reindex(columns=header)\n        df[\"sample\"] = [file]\n        dfs.append(df)\n    return pd.concat(dfs)\n\ncombined_header = get_header_lines(files, directory)\ndf = write_merged_file(files, combined_header, directory)\n\ndf.to_csv('/tmp/output', index=False)\ns=df.shape\nwith open('/tmp/metrics', 'w') as f:\n    f.write(json.dumps({'num_rows': s[0], 'num_cols': s[1]}))\n"
          "artifacts": !!null "null"
      - "name": "quantify-paired-end-materialized"
        "template": "materialized-node"
        "dependencies":
        - "quantify-paired-end"
        "arguments":
          "parameters":
          - "name": "script"
            "value": "import pandas as pd\nimport tensorflow_data_validation as tfdv\nimport google.protobuf.json_format as json_format\n\ndf = pd.read_csv('/tmp/dataframe1', nrows=5000)\ndf = df[df.columns[0:500]]\n\ntry:\n    stats = tfdv.generate_statistics_from_dataframe(df)\n    schema = tfdv.infer_schema(stats)\n    with open('/tmp/stats.json', 'w') as f:\n        f.write(json_format.MessageToJson(stats))\n    with open('/tmp/schema.json', 'w') as f:\n        f.write(json_format.MessageToJson(schema))\nexcept:\n    for col in df.columns:\n        try:\n            tfdv.generate_statistics_from_dataframe(df[[col]])\n        except Exception as e:\n            print(f\"Please investigate column {col}, could not infer stats with exception {e}\")\n    raise Exception(\"Could not output stats for input dataframe, please investigate.\")\n    \n"
          "artifacts":
          - "name": "dataframe1"
            "path": "/tmp/dataframe1"
            "from": "tasks.quantify-paired-end.outputs.artifacts.output"
